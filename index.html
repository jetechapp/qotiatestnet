<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>QOTIA V70 MUSK ED</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #0F172A;        
            --bg-body: #F8FAFC;        
            --surface: #FFFFFF;
            --border: #CBD5E1;
            --text-main: #1E293B;      
            --text-sub: #64748B;
            --accent: #F59E0B;
            --time-color: #3B82F6; /* Colore per il tempo */
            --danger: #EF4444; 
            --success: #15803d;
            
            --h-header: 65px;
            --h-nav: 90px;
            --radius: 16px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); color: var(--text-main); 
            font-size: 15px; 
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column; overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        /* --- LAYOUT --- */
        .view-section { 
            display: none; flex-direction: column; height: 100%; width: 100%; 
            position: absolute; top: 0; left: 0; 
            background: var(--bg-body); z-index: 10;
        }
        .view-section.active { display: flex; z-index: 20; }
        
        /* HEADER STICKY */
        .mobile-header { 
            flex-shrink: 0; height: var(--h-header); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; position: sticky; top: 0; z-index: 50; 
        }
        .logo-text { font-weight: 800; font-size: 1.3rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .header-action-btn {
            background: var(--primary); color: white; border: none; border-radius: 30px;
            padding: 8px 18px; font-weight: 700; font-size: 0.85rem;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
        }
        .header-action-btn:active { transform: scale(0.96); }
        .header-back-container { display: flex; align-items: center; gap: 5px; background: transparent; border: none; cursor: pointer; color: var(--primary); font-weight: 700; font-size: 0.9rem; }
        .header-back-container i { font-size: 1.2rem; }

        /* SCROLL CONTENT */
        .scroll-content { 
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; 
            -webkit-overflow-scrolling: touch;
        }

        /* COMPONENTS */
        .card-item { 
            background: white; padding: 18px; margin-bottom: 12px; 
            border-radius: 14px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: var(--shadow-card);
        }
        .card-info { flex: 1; }
        .card-title { font-weight: 800; font-size: 1.05rem; color: var(--primary); margin-bottom: 4px; }
        .card-sub { font-size: 0.9rem; color: var(--text-sub); display: flex; align-items: center; gap: 6px; }
        
        .section-separator { display: flex; align-items: center; justify-content: space-between; margin-top: 25px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #E2E8F0; }
        .section-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); }
        .action-create-btn { background: white; color: var(--primary); border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; cursor: pointer; }

        /* NAV */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--h-nav); 
            background: white; border-top: 1px solid var(--border); 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            z-index: 1000; align-items: flex-start; padding-top: 14px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94A3B8; background: transparent; border: none; font-size: 0.7rem; font-weight: 600; gap: 5px; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 1.5rem; }

        /* MODALS */
        .app-input { width: 100%; height: 50px; background: #fff; border: 2px solid #E2E8F0; border-radius: 12px; padding: 0 15px; font-size: 1rem; color: var(--primary); margin-bottom: 15px; outline: none; font-weight: 500; appearance: none; }
        .app-input:focus { border-color: var(--primary); }
        .btn-primary { width: 100%; height: 50px; background: var(--primary); color: white; font-weight: 700; border-radius: 12px; border: none; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }
        
        .full-modal { position: fixed; inset: 0; background: #F8FAFC; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 5000; }
        .full-modal.open { transform: translateY(0); }
        .modal-header { height: 70px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-weight: 800; font-size: 1.2rem; flex-shrink: 0; }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; padding-bottom: 100px; }
        .modal-footer { padding: 20px; background: white; border-top: 1px solid var(--border); padding-bottom: max(20px, env(safe-area-inset-bottom)); flex-shrink: 0; }

        /* --- NEW EDITOR STYLES --- */
        .editor-header-wrapper { background: white; border-bottom: 1px solid var(--border); padding-bottom: 0; flex-shrink: 0; display:flex; flex-direction:column; }
        
        .client-badge { font-size: 0.8rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .project-title { font-size: 1.1rem; font-weight: 900; color: var(--primary); margin-top: 2px; }
        
        .kpi-row { display: flex; gap: 15px; margin-top: 10px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; }
        .kpi-box { flex: 1; background: #F8FAFC; padding: 8px; border-radius: 8px; text-align: center; }
        .kpi-label { font-size: 0.7rem; color: #64748B; font-weight: 700; text-transform: uppercase; }
        .kpi-val { font-size: 1.1rem; font-weight: 800; }
        
        .view-toggle { display: flex; padding: 10px 20px; gap: 10px; background: white; }
        .toggle-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #F1F5F9; color: #64748B; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(15,23,42,0.2); }

        /* PIECE & OUVRAGE CARDS */
        .piece-section { margin-bottom: 20px; }
        .piece-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 5px; cursor: pointer; }
        .piece-title { font-weight: 800; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .piece-badge { background: #E0F2FE; color: #0284C7; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }

        .e-card { background: white; margin: 0 0 10px 0; padding: 15px; border-radius: 12px; border: 1px solid var(--border); position: relative; box-shadow: var(--shadow-card); }
        .e-card-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .e-desc { font-weight: 700; color: var(--text-main); font-size: 0.95rem; width: 70%; line-height: 1.4; }
        .e-loc-tag { display: inline-block; font-size: 0.7rem; font-weight: 700; color: #64748B; background: #F1F5F9; padding: 2px 6px; border-radius: 4px; margin-top: 4px; }
        
        .e-stats { display: flex; gap: 10px; border-top: 1px solid #F1F5F9; padding-top: 10px; }
        .stat-box { flex: 1; text-align: center; }
        .stat-lbl { font-size: 0.65rem; color: #94A3B8; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .stat-val { font-size: 0.9rem; font-weight: 700; color: var(--primary); }
        .stat-val.time { color: var(--time-color); }
        
        .floating-fab { position: fixed; bottom: 110px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 1.6rem; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; z-index: 100; cursor: pointer; transition: transform 0.1s; }
        .floating-fab:active { transform: scale(0.9); }

        #toast-container { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 9000; pointer-events: none; width: 85%; }
        .toast { background: #1E293B; color: white; padding: 14px; border-radius: 50px; font-weight: 600; font-size: 0.9rem; opacity: 0; transform: translateY(20px); transition: all 0.3s; margin-top: 10px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <main id="view-home" class="view-section active">
        <header class="mobile-header">
            <div class="logo-text"><i class="fas fa-hammer"></i> QOTIA <span style="font-size:0.7em; opacity:0.6; font-weight:400;">v70</span></div>
            <button style="background:none; border:none; font-size:1.2rem;" onclick="App.nav('settings')"><i class="fas fa-cog"></i></button>
        </header>
        <div class="scroll-content">
            <div style="margin-bottom:20px;">
                <h1 style="margin:0; font-size:1.8rem; color:var(--primary);">Bonjour, Jean</h1>
                <p style="margin:0; color:var(--text-sub);" id="home-date-display">...</p>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                <button onclick="App.nav('projets')" style="height:100px; background:white; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-card); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;">
                    <i class="fas fa-hard-hat" style="font-size:1.8rem; color:#D97706;"></i><span style="font-weight:800; font-size:0.8rem;">CHANTIERS</span>
                </button>
                <button onclick="App.nav('clients')" style="height:100px; background:white; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-card); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;">
                    <i class="fas fa-users" style="font-size:1.8rem; color:#2563EB;"></i><span style="font-weight:800; font-size:0.8rem;">CLIENTS</span>
                </button>
            </div>
            <div class="section-title">En cours</div>
            <div id="home-recent-list"></div>
        </div>
    </main>

    <main id="view-editor" class="view-section">
        <div class="editor-header-wrapper">
            <div style="padding:10px 20px 0 20px; display:flex; justify-content:space-between; align-items:flex-start;">
                <button class="header-back-container" onclick="App.openHub(Store.data.activeChantierId)"><i class="fas fa-chevron-left"></i> Retour</button>
                <button style="background:none; border:none; font-size:1.2rem; color:var(--primary);" onclick="App.openSettings()"><i class="fas fa-ellipsis-v"></i></button>
            </div>
            
            <div style="padding: 5px 20px;">
                <div class="client-badge" id="ed-client-name">CLIENT NAME</div>
                <div class="project-title" id="ed-quote-name">Quote Name</div>
                
                <div class="kpi-row">
                    <div class="kpi-box">
                        <div class="kpi-label">Total €</div>
                        <div class="kpi-val" id="ed-total-price" style="color:var(--primary);">0 €</div>
                    </div>
                    <div class="kpi-box">
                        <div class="kpi-label">Temps (H)</div>
                        <div class="kpi-val" id="ed-total-time" style="color:var(--time-color);">0h</div>
                    </div>
                </div>
            </div>

            <div class="view-toggle">
                <button class="toggle-btn active" id="btn-view-pieces" onclick="App.setEditorView('pieces')">PAR PIÈCES</button>
                <button class="toggle-btn" id="btn-view-ouvrages" onclick="App.setEditorView('ouvrages')">PAR OUVRAGES</button>
            </div>
        </div>

        <div class="scroll-content" id="editor-list-container" style="padding-top:20px; background:#F1F5F9;">
            </div>

        <button class="floating-fab" onclick="App.openLibrary()"><i class="fas fa-plus"></i></button>
    </main>

    <main id="view-clients" class="view-section">
        <header class="mobile-header">
            <button class="header-back-container" onclick="App.nav('home')"><i class="fas fa-chevron-left"></i></button>
            <div class="logo-text">CLIENTS</div>
            <button class="header-action-btn" onclick="App.openClientModal()">+</button>
        </header>
        <div class="scroll-content" id="clients-list"></div>
    </main>

    <main id="view-projets" class="view-section">
        <header class="mobile-header">
            <button class="header-back-container" onclick="App.nav('home')"><i class="fas fa-chevron-left"></i></button>
            <div class="logo-text">CHANTIERS</div>
            <button class="header-action-btn" onclick="App.openProjectWizard()">+</button>
        </header>
        <div class="scroll-content" id="projects-list-full"></div>
    </main>

    <main id="view-hub" class="view-section">
        <header class="mobile-header">
            <button class="header-back-container" onclick="App.nav('projets')"><i class="fas fa-chevron-left"></i> Chantiers</button>
            <div class="logo-text">DASHBOARD</div>
            <div style="width:50px"></div>
        </header>
        <div class="scroll-content" style="padding:0;">
            <div style="background:white; padding:20px; border-bottom:1px solid var(--border);">
                <div style="font-size:0.8rem; font-weight:700; color:var(--text-sub);" id="hub-client-name">-</div>
                <div style="font-size:1.5rem; font-weight:900; color:var(--primary); margin-bottom:10px;" id="hub-prj-name">-</div>
                <button class="action-create-btn" onclick="App.createNewDevis()" style="background:var(--primary); color:white; width:100%; justify-content:center; height:45px;">+ CRÉER UN DEVIS</button>
            </div>
            <div style="padding:20px;" id="hub-devis-list"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="App.nav('home')" id="nav-home"><i class="fas fa-home"></i><span>Accueil</span></button>
        <button class="nav-btn" onclick="App.nav('projets')" id="nav-projets"><i class="fas fa-hard-hat"></i><span>Projets</span></button>
        <button class="nav-btn" onclick="App.nav('clients')" id="nav-clients"><i class="fas fa-users"></i><span>Clients</span></button>
        <button class="nav-btn" onclick="App.nav('settings')" id="nav-settings"><i class="fas fa-cog"></i><span>Réglages</span></button>
    </nav>

    <div id="modal-client" class="full-modal">
        <div class="modal-header"><h3>Nouveau Client</h3><button class="header-back-container" onclick="App.closeModal('modal-client')">×</button></div>
        <div class="modal-body">
            <input type="text" id="cli-nom" class="app-input" placeholder="Nom Complet">
            <input type="text" id="cli-addr" class="app-input" placeholder="Adresse">
            <input type="tel" id="cli-tel" class="app-input" placeholder="Téléphone">
        </div>
        <div class="modal-footer"><button class="btn-primary" onclick="App.saveClient()">ENREGISTRER</button></div>
    </div>

    <div id="modal-projet" class="full-modal">
        <div class="modal-header"><h3>Nouveau Chantier</h3><button class="header-back-container" onclick="App.closeModal('modal-projet')">×</button></div>
        <div class="modal-body">
            <select id="prj-cli" class="app-input"></select>
            <input type="text" id="prj-nom" class="app-input" placeholder="Nom Chantier (ex: Rénov Cuisine)">
        </div>
        <div class="modal-footer"><button class="btn-primary" onclick="App.createProject()">CRÉER</button></div>
    </div>

    <div id="modal-library" class="full-modal">
        <div class="modal-header"><h3>Bibliothèque</h3><button class="header-back-container" onclick="App.closeModal('modal-library')">×</button></div>
        <div class="modal-body">
            <div style="background:#FFF; border:2px solid var(--primary); padding:10px; border-radius:12px; margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-sub);">Ajouter dans la pièce :</label>
                <select id="lib-target-piece" class="app-input" style="margin:0; height:40px; border:none; font-weight:800; color:var(--primary); padding:0;">
                    </select>
                <input type="text" id="lib-new-piece" placeholder="ou Nouvelle Pièce..." class="app-input" style="margin-top:5px; display:none; height:40px;">
                <div style="text-align:right; font-size:0.75rem; color:var(--accent); font-weight:700; cursor:pointer;" onclick="App.toggleNewPieceInput()">+ Créer nouvelle pièce</div>
            </div>
            <div id="lib-container"></div>
        </div>
    </div>

    <div id="modal-edit-item" class="full-modal">
        <div class="modal-header"><h3>Modifier Ouvrage</h3><button class="header-back-container" onclick="App.closeModal('modal-edit-item')">×</button></div>
        <div class="modal-body">
            <input type="hidden" id="edit-item-idx">
            
            <label style="font-weight:700; color:var(--text-sub);">Localisation</label>
            <select id="edit-item-piece" class="app-input"></select>

            <label style="font-weight:700; color:var(--text-sub);">Description</label>
            <input type="text" id="edit-item-desc" class="app-input">

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label style="font-weight:700; color:var(--text-sub);">Qté</label>
                    <input type="number" id="edit-item-qty" class="app-input">
                </div>
                <div style="flex:1">
                    <label style="font-weight:700; color:var(--text-sub);">Unité</label>
                    <input type="text" id="edit-item-unit" class="app-input" disabled style="background:#f1f5f9;">
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label style="font-weight:700; color:var(--text-sub);">Prix Unit (€)</label>
                    <input type="number" id="edit-item-price" class="app-input">
                </div>
                <div style="flex:1">
                    <label style="font-weight:700; color:#3B82F6;">Temps Unit (h)</label>
                    <input type="number" id="edit-item-time" class="app-input" style="border-color:#3B82F6; color:#3B82F6;">
                </div>
            </div>

            <div style="margin-top:20px; padding:15px; background:#F8FAFC; border-radius:12px; border:1px solid #E2E8F0;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>Total Prix:</span>
                    <strong id="preview-total-price">0 €</strong>
                </div>
                <div style="display:flex; justify-content:space-between; color:#3B82F6;">
                    <span>Total Heures:</span>
                    <strong id="preview-total-time">0 h</strong>
                </div>
            </div>

            <button class="btn-primary" style="background:#fee2e2; color:#dc2626; margin-top:20px;" onclick="App.deleteItem()">SUPPRIMER LIGNE</button>
        </div>
        <div class="modal-footer"><button class="btn-primary" onclick="App.saveItemChanges()">ENREGISTRER</button></div>
    </div>

    <script>
        // CONFIGURAZIONE LIBRERIA (Include TEMPO)
        const Config = { 
            LIB: { 
                "Préparation": [
                    {desc:"Protection sols", unit:"m²", price:5, time:0.1}, 
                    {desc:"Dépose carrelage", unit:"m²", price:25, time:0.5},
                    {desc:"Evacuation gravats", unit:"forfait", price:150, time:2}
                ], 
                "Maçonnerie": [
                    {desc:"Ragréage P3", unit:"m²", price:18, time:0.3}, 
                    {desc:"Chape ciment", unit:"m²", price:45, time:0.8},
                    {desc:"Cloison BA13", unit:"m²", price:55, time:0.7}
                ], 
                "Plomberie": [
                    {desc:"Pose WC Suspendu", unit:"U", price:450, time:4}, 
                    {desc:"Création arrivée eau", unit:"U", price:120, time:2},
                    {desc:"Pose Robinetterie", unit:"U", price:80, time:0.5}
                ], 
                "Peinture": [
                    {desc:"Ratissage murs", unit:"m²", price:18, time:0.4},
                    {desc:"Impression", unit:"m²", price:12, time:0.2}, 
                    {desc:"Peinture mate 2c", unit:"m²", price:22, time:0.35}
                ], 
                "Electricité": [
                    {desc:"Prise courant", unit:"U", price:65, time:0.5}, 
                    {desc:"Point lumineux", unit:"U", price:75, time:0.6},
                    {desc:"Tableau Elec", unit:"U", price:1200, time:8}
                ] 
            } 
        };

        const Store = {
            data: { clients: [], chantiers: [] },
            init() { 
                const s = localStorage.getItem('qotia_v70_musk'); 
                if(s) this.data = JSON.parse(s); 
                else this.seed(); 
            },
            seed() {
                this.data.clients = [{id:1, nom:'M. Elon Musk', tel:'0600000000', addr:'Gigafactory 1'}];
                this.data.chantiers = [];
                this.save();
            },
            save() { localStorage.setItem('qotia_v70_musk', JSON.stringify(this.data)); }
        };

        const App = {
            state: { viewMode: 'pieces', tempNewPiece: false }, // 'pieces' or 'ouvrages'

            init() { 
                Store.init(); 
                this.renderHome();
                document.getElementById('home-date-display').innerText = new Date().toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
            },

            nav(view) {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
                
                const vid = 'view-' + view;
                const el = document.getElementById(vid);
                if(el) el.classList.add('active');
                
                const nid = 'nav-' + view;
                const nel = document.getElementById(nid);
                if(nel) nel.classList.add('active');

                if(view === 'clients') this.renderClients();
                if(view === 'projets') this.renderProjects();
            },

            showToast(msg) {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = msg;
                c.appendChild(t); 
                setTimeout(()=>t.classList.add('show'),10); 
                setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},3000);
            },

            // --- CLIENTS ---
            renderClients() {
                const l = document.getElementById('clients-list'); l.innerHTML = '';
                Store.data.clients.forEach(c => {
                    l.innerHTML += `<div class="card-item"><div class="card-info"><div class="card-title">${c.nom}</div><div class="card-sub">${c.addr}</div></div></div>`;
                });
            },
            openClientModal() { document.getElementById('cli-nom').value=''; document.getElementById('modal-client').classList.add('open'); },
            saveClient() {
                const nom = document.getElementById('cli-nom').value;
                if(!nom) return;
                Store.data.clients.push({id:Date.now(), nom:nom, addr:document.getElementById('cli-addr').value, tel:document.getElementById('cli-tel').value});
                Store.save(); App.closeModal('modal-client'); App.renderClients();
            },

            // --- PROJETS ---
            renderProjects() {
                const l = document.getElementById('projects-list-full'); l.innerHTML = '';
                Store.data.chantiers.forEach(c => {
                    const cli = Store.data.clients.find(x=>x.id==c.clientId);
                    l.innerHTML += `<div class="card-item" onclick="App.openHub(${c.id})"><div class="card-info"><div class="card-title">${c.name}</div><div class="card-sub">${cli?cli.nom:'?'}</div></div><i class="fas fa-chevron-right"></i></div>`;
                });
            },
            openProjectWizard() {
                const s = document.getElementById('prj-cli'); s.innerHTML='';
                Store.data.clients.forEach(c => s.innerHTML+=`<option value="${c.id}">${c.nom}</option>`);
                document.getElementById('modal-projet').classList.add('open');
            },
            createProject() {
                const cid = document.getElementById('prj-cli').value;
                const nom = document.getElementById('prj-nom').value;
                if(cid && nom) {
                    const newId = Date.now();
                    Store.data.chantiers.unshift({id:newId, clientId:cid, name:nom, devisList:[]});
                    Store.save(); App.closeModal('modal-projet'); App.openHub(newId);
                }
            },
            openHub(id) {
                Store.data.activeChantierId = id;
                const c = Store.data.chantiers.find(x=>x.id==id);
                const cli = Store.data.clients.find(x=>x.id==c.clientId);
                document.getElementById('hub-client-name').innerText = cli ? cli.nom : 'Inconnu';
                document.getElementById('hub-prj-name').innerText = c.name;
                
                const l = document.getElementById('hub-devis-list'); l.innerHTML = '';
                c.devisList.forEach(d => {
                    l.innerHTML += `<div class="card-item" onclick="App.openEditor(${d.id})"><div class="card-info"><div class="card-title">${d.name}</div><div class="card-sub">${d.items.length} ouvrages</div></div><div style="font-weight:800;">${Math.round(d.total||0)} €</div></div>`;
                });
                this.nav('hub');
            },
            createNewDevis() {
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const newId = Date.now();
                c.devisList.push({id:newId, name:'Devis #'+(c.devisList.length+1), items:[], total:0, totalTime:0});
                Store.save(); App.openEditor(newId);
            },

            // --- EDITOR LOGIC (THE CORE) ---
            openEditor(did) {
                Store.data.activeDevisId = did;
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const cli = Store.data.clients.find(x=>x.id==c.clientId);
                const d = c.devisList.find(x=>x.id==did);

                // Setup Header
                document.getElementById('ed-client-name').innerText = cli ? cli.nom : 'CLIENT?';
                document.getElementById('ed-quote-name').innerText = c.name + " - " + d.name;
                
                this.calcTotals();
                this.nav('editor');
                this.setEditorView('pieces'); // Default View
            },

            calcTotals() {
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                let tPrice = 0; let tTime = 0;
                d.items.forEach(i => {
                    tPrice += (i.qty * i.price);
                    tTime += (i.qty * (i.time || 0));
                });
                d.total = tPrice; d.totalTime = tTime;
                Store.save();
                document.getElementById('ed-total-price').innerText = Math.round(tPrice).toLocaleString() + ' €';
                document.getElementById('ed-total-time').innerText = tTime.toFixed(1) + ' h';
            },

            setEditorView(mode) {
                App.state.viewMode = mode;
                document.getElementById('btn-view-pieces').className = mode === 'pieces' ? 'toggle-btn active' : 'toggle-btn';
                document.getElementById('btn-view-ouvrages').className = mode === 'ouvrages' ? 'toggle-btn active' : 'toggle-btn';
                App.renderEditorItems();
            },

            renderEditorItems() {
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                const container = document.getElementById('editor-list-container');
                container.innerHTML = '';

                if(d.items.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:40px; color:#94A3B8;">Vide. Commencez par ajouter un ouvrage +</div>';
                    return;
                }

                if(App.state.viewMode === 'pieces') {
                    // GROUP BY PIECE
                    const grouped = {};
                    d.items.forEach(i => {
                        const p = i.piece || "Zone Générale";
                        if(!grouped[p]) grouped[p] = [];
                        grouped[p].push(i);
                    });

                    for(const [piece, items] of Object.entries(grouped)) {
                        let html = `<div class="piece-section">
                            <div class="piece-header">
                                <div class="piece-title"><i class="fas fa-door-open"></i> ${piece}</div>
                                <span class="piece-badge">${items.length}</span>
                            </div>`;
                        
                        items.forEach(i => {
                            html += App.createItemCard(i, false); // false = hide piece tag inside
                        });
                        html += `</div>`;
                        container.innerHTML += html;
                    }

                } else {
                    // GLOBAL VIEW (BY OUVRAGE TYPE/NAME)
                    // Aggregate similar items just for display? Or list all?
                    // Request says: "visualizzazione per ouvrage completi... indicata in quale piece è presente e per quante unita"
                    
                    // Let's sort by description to group them visually
                    const sorted = [...d.items].sort((a,b) => a.desc.localeCompare(b.desc));
                    
                    sorted.forEach(i => {
                        container.innerHTML += App.createItemCard(i, true); // true = show piece tag
                    });
                }
            },

            createItemCard(item, showPiece) {
                const totalP = item.qty * item.price;
                const totalT = item.qty * (item.time || 0);
                
                return `<div class="e-card" onclick="App.editItem(${item.id})">
                    <div class="e-card-row">
                        <div class="e-desc">
                            ${item.desc}
                            ${showPiece ? `<br><span class="e-loc-tag"><i class="fas fa-map-marker-alt"></i> ${item.piece || 'Général'}</span>` : ''}
                        </div>
                        <div style="font-size:1.1rem; font-weight:800; color:var(--primary);">${Math.round(totalP)}€</div>
                    </div>
                    <div class="e-stats">
                        <div class="stat-box">
                            <div class="stat-lbl">Qté</div>
                            <div class="stat-val">${item.qty} <span style="font-size:0.7em">${item.unit}</span></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-lbl">Prix U.</div>
                            <div class="stat-val">${item.price}€</div>
                        </div>
                         <div class="stat-box">
                            <div class="stat-lbl">Temps U.</div>
                            <div class="stat-val time">${item.time}h</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-lbl">Total H</div>
                            <div class="stat-val time">${totalT.toFixed(1)}h</div>
                        </div>
                    </div>
                </div>`;
            },

            // --- ADD / EDIT ITEMS ---
            openLibrary() {
                // Determine existing rooms to populate select
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                const rooms = new Set(d.items.map(i => i.piece).filter(Boolean));
                
                const sel = document.getElementById('lib-target-piece');
                sel.innerHTML = '<option value="Zone Générale">Zone Générale</option>';
                rooms.forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
                
                // Show standard rooms if list is empty
                if(rooms.size === 0) {
                    ['Cuisine', 'SDB', 'Salon', 'Chambre 1'].forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
                }

                // Render Library Items
                const cont = document.getElementById('lib-container');
                cont.innerHTML = '';
                for(let [cat, items] of Object.entries(Config.LIB)) {
                    cont.innerHTML += `<div style="font-weight:800; margin-top:15px; margin-bottom:8px; color:var(--text-sub);">${cat}</div>`;
                    items.forEach(it => {
                        cont.innerHTML += `<div class="card-item" style="padding:12px;" onclick="App.addLibItem('${it.desc}', '${it.unit}', ${it.price}, ${it.time})">
                            <div>
                                <div style="font-weight:700;">${it.desc}</div>
                                <div style="font-size:0.8rem; color:var(--text-sub);">${it.price}€ / ${it.time}h</div>
                            </div>
                            <i class="fas fa-plus-circle" style="color:var(--primary); font-size:1.4rem;"></i>
                        </div>`;
                    });
                }
                document.getElementById('modal-library').classList.add('open');
            },

            toggleNewPieceInput() {
                const inp = document.getElementById('lib-new-piece');
                const sel = document.getElementById('lib-target-piece');
                if(inp.style.display === 'none') {
                    inp.style.display = 'block'; sel.style.display = 'none'; inp.focus();
                } else {
                    inp.style.display = 'none'; sel.style.display = 'block';
                }
            },

            addLibItem(desc, unit, price, time) {
                // Get target piece
                let piece = document.getElementById('lib-target-piece').value;
                const newP = document.getElementById('lib-new-piece').value;
                if(document.getElementById('lib-new-piece').style.display !== 'none' && newP) {
                    piece = newP;
                }

                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                
                d.items.push({
                    id: Date.now(),
                    piece: piece,
                    desc: desc,
                    unit: unit,
                    qty: 1,
                    price: price,
                    time: time
                });
                
                Store.save();
                App.showToast(`Ajouté dans ${piece}`);
                App.closeModal('modal-library');
                App.calcTotals();
                App.renderEditorItems();
            },

            editItem(id) {
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                const idx = d.items.findIndex(i => i.id == id);
                const item = d.items[idx];

                document.getElementById('edit-item-idx').value = idx;
                document.getElementById('edit-item-desc').value = item.desc;
                document.getElementById('edit-item-qty').value = item.qty;
                document.getElementById('edit-item-unit').value = item.unit;
                document.getElementById('edit-item-price').value = item.price;
                document.getElementById('edit-item-time').value = item.time || 0;

                // Populate Piece Selector in Edit
                const rooms = new Set(d.items.map(i => i.piece).filter(Boolean));
                const sel = document.getElementById('edit-item-piece');
                sel.innerHTML = `<option value="${item.piece}">${item.piece}</option>`;
                rooms.forEach(r => { if(r!==item.piece) sel.innerHTML += `<option value="${r}">${r}</option>`; });
                
                document.getElementById('modal-edit-item').classList.add('open');
            },

            saveItemChanges() {
                const idx = document.getElementById('edit-item-idx').value;
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                const item = d.items[idx];

                item.piece = document.getElementById('edit-item-piece').value;
                item.desc = document.getElementById('edit-item-desc').value;
                item.qty = parseFloat(document.getElementById('edit-item-qty').value) || 0;
                item.price = parseFloat(document.getElementById('edit-item-price').value) || 0;
                item.time = parseFloat(document.getElementById('edit-item-time').value) || 0;

                Store.save();
                App.closeModal('modal-edit-item');
                App.calcTotals();
                App.renderEditorItems();
            },

            deleteItem() {
                if(!confirm("Supprimer ?")) return;
                const idx = document.getElementById('edit-item-idx').value;
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                d.items.splice(idx, 1);
                Store.save();
                App.closeModal('modal-edit-item');
                App.calcTotals();
                App.renderEditorItems();
            },

            renderHome() { /* Placeholder basic home */
                const l = document.getElementById('home-recent-list'); l.innerHTML = '';
                Store.data.chantiers.slice(0,3).forEach(c => l.innerHTML += `<div class="card-item" onclick="App.openHub(${c.id})"><div class="card-info"><div class="card-title">${c.name}</div></div></div>`);
            },
            closeModal(id) { document.getElementById(id).classList.remove('open'); }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
